#!/usr/bin/env python3
"""
üé≠üöÄ Celebrity AI Assistant Suite - Streamlit Frontend
====================================================
Beautiful web interface for all celebrity AI features:
- Live David Attenborough Webcam Narrator
- Celebrity Calendar Assistant with Real Google Calendar
- Multi-Celebrity Companion Chat
- Voice-enabled interactions with Google Cloud TTS
"""

import streamlit as st

# Configure Streamlit page FIRST (before any other st. commands)
st.set_page_config(
    page_title="üé≠ Celebrity AI Assistant Suite",
    page_icon="üé¨",
    layout="wide",
    initial_sidebar_state="expanded"
)

import os
import sys
import time
import base64
import tempfile
import threading
from datetime import datetime, timedelta
from pathlib import Path
import cv2
import numpy as np
from PIL import Image
import json
import subprocess
from typing import Dict, Any, Optional

# Add the current directory to Python path for imports
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

# Import our backend modules
try:
    from narrator import encode_image, analyze_image, play_audio, stop_audio
    NARRATOR_AVAILABLE = True
except ImportError as e:
    st.error(f"Narrator module not available: {e}")
    NARRATOR_AVAILABLE = False

try:
    from gmail_reader import GmailReader
    GMAIL_AVAILABLE = True
    print("‚úÖ Enhanced Gmail reader imported successfully")
except ImportError as e:
    print(f"‚ö†Ô∏è Gmail module not available: {e}")
    GMAIL_AVAILABLE = False

try:
    from celebrity_companion_ai_clean import CelebrityCompanionAI
    COMPANION_AVAILABLE = True
except ImportError as e:
    try:
        # Fallback to simple companion
        from simple_celebrity_companion import CelebrityCompanionAI
        COMPANION_AVAILABLE = True
        st.info("Using simplified celebrity companion (Portia unavailable)")
    except ImportError as e2:
        st.error(f"Celebrity Companion not available: {e2}")
        COMPANION_AVAILABLE = False

try:
    from celebrity_calendar_assistant import CalendarCelebrityVoice, init_portia_calendar, execute_calendar_action_with_portia, generate_calendar_script, setup_content_generator
    CALENDAR_AVAILABLE = True
except ImportError as e:
    st.error(f"Calendar Assistant not available: {e}")
    CALENDAR_AVAILABLE = False

# Custom CSS for better UI
st.markdown("""
<style>
    .main-header {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        padding: 2rem;
        border-radius: 10px;
        color: white;
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .celebrity-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        padding: 1.5rem;
        border-radius: 15px;
        color: white;
        margin-bottom: 1rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .feature-box {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        padding: 1rem;
        border-radius: 10px;
        color: white;
        text-align: center;
        margin-bottom: 1rem;
    }
    
    .status-success {
        background-color: #d4edda;
        color: #155724;
        padding: 0.75rem;
        border-radius: 5px;
        border-left: 4px solid #28a745;
        margin: 1rem 0;
    }
    
    .status-error {
        background-color: #f8d7da;
        color: #721c24;
        padding: 0.75rem;
        border-radius: 5px;
        border-left: 4px solid #dc3545;
        margin: 1rem 0;
    }
    
    .chat-message {
        padding: 1rem;
        margin: 0.5rem 0;
        border-radius: 10px;
        max-width: 80%;
    }
    
    .chat-user {
        background-color: #e3f2fd;
        margin-left: auto;
        text-align: right;
    }
    
    .chat-celebrity {
        background-color: #f3e5f5;
        margin-right: auto;
        text-align: left;
    }
    
    .sidebar .stSelectbox {
        margin-bottom: 1rem;
    }
</style>
""", unsafe_allow_html=True)

# Initialize session state
if 'companion_ai' not in st.session_state:
    st.session_state.companion_ai = None
if 'calendar_voice' not in st.session_state:
    st.session_state.calendar_voice = None
if 'portia_calendar' not in st.session_state:
    st.session_state.portia_calendar = None
if 'narrator_running' not in st.session_state:
    st.session_state.narrator_running = False
if 'chat_history' not in st.session_state:
    st.session_state.chat_history = []
if 'current_celebrity' not in st.session_state:
    st.session_state.current_celebrity = None
if 'conversation_file' not in st.session_state:
    st.session_state.conversation_file = "streamlit_chat_history.json"

def load_chat_history():
    """Load chat history from file"""
    try:
        if os.path.exists(st.session_state.conversation_file):
            with open(st.session_state.conversation_file, 'r') as f:
                return json.load(f)
    except Exception as e:
        st.error(f"Error loading chat history: {e}")
    return []

def save_chat_history():
    """Save chat history to file"""
    try:
        with open(st.session_state.conversation_file, 'w') as f:
            json.dump(st.session_state.chat_history, f, indent=2)
    except Exception as e:
        st.error(f"Error saving chat history: {e}")

def init_companion_ai():
    """Initialize the Celebrity Companion AI"""
    if COMPANION_AVAILABLE and st.session_state.companion_ai is None:
        try:
            with st.spinner("üé≠ Initializing Celebrity Companion AI..."):
                # Try to import the main companion first
                try:
                    from celebrity_companion_ai_clean import CelebrityCompanionAI
                    st.session_state.companion_ai = CelebrityCompanionAI()
                    st.info("‚úÖ Using full Celebrity Companion AI")
                except Exception as e:
                    # Fall back to simple companion
                    from simple_celebrity_companion import SimpleCelebrityCompanionAI
                    st.session_state.companion_ai = SimpleCelebrityCompanionAI()
                    st.info("‚úÖ Using simplified Celebrity Companion AI (Portia issues)")
                
                st.session_state.chat_history = load_chat_history()
            return True
        except Exception as e:
            st.error(f"Failed to initialize Celebrity Companion AI: {e}")
            return False
    return st.session_state.companion_ai is not None

def init_calendar_system():
    """Initialize the Calendar Assistant"""
    if CALENDAR_AVAILABLE and st.session_state.calendar_voice is None:
        try:
            with st.spinner("üìÖ Initializing Calendar System..."):
                st.session_state.calendar_voice = CalendarCelebrityVoice()
                
                # Try to initialize Portia with timeout handling
                try:
                    st.session_state.portia_calendar = init_portia_calendar()
                    if st.session_state.portia_calendar:
                        st.success("‚úÖ Calendar system initialized with Portia")
                    else:
                        st.warning("‚ö†Ô∏è Calendar initialized but Portia unavailable (timeout)")
                        st.info("Voice features available, but calendar integration limited")
                except Exception as e:
                    st.warning(f"‚ö†Ô∏è Portia initialization failed: {e}")
                    st.info("Voice features available, but calendar integration limited")
                    st.session_state.portia_calendar = None
                    
            return True
        except Exception as e:
            st.error(f"Failed to initialize Calendar System: {e}")
            return False
    return st.session_state.calendar_voice is not None

def main_header():
    """Display main header"""
    st.markdown("""
    <div class="main-header">
        <h1>üé¨ü§ñ Celebrity AI Assistant Suite</h1>
        <p>Transform your digital life with AI-powered celebrity companions!</p>
        <p>üìÖ Calendar Management | üé• Live Commentary | üí¨ Celebrity Chat | üîä Authentic Voices</p>
    </div>
    """, unsafe_allow_html=True)

def celebrity_selection_sidebar():
    """Celebrity selection in sidebar"""
    st.sidebar.markdown("## üé≠ Celebrity Selection")
    
    celebrities = {
        "david": "üåø David Attenborough - Nature Wisdom",
        "morgan": "üé¨ Morgan Freeman - Deep Philosophy", 
        "scarlett": "üî• Scarlett Johansson - Modern Psychology",
        "peter": "üòÇ Peter Griffin - Relatable Humor"
    }
    
    selected = st.sidebar.selectbox(
        "Choose your celebrity companion:",
        options=list(celebrities.keys()),
        format_func=lambda x: celebrities[x],
        index=0
    )
    
    st.session_state.current_celebrity = selected
    return selected

def webcam_narrator_tab():
    """David Attenborough Webcam Narrator"""
    st.markdown("## üé• David Attenborough Live Commentary")
    st.markdown("**Experience real-time nature documentary narration of your webcam feed!**")
    
    col1, col2 = st.columns([2, 1])
    
    with col1:
        st.markdown("""
        <div class="feature-box">
            <h3>üåü Features</h3>
            <p>‚Ä¢ Live webcam analysis with Google Gemini AI</p>
            <p>‚Ä¢ Real-time documentary commentary</p>
            <p>‚Ä¢ Context-aware narrative building</p>
            <p>‚Ä¢ Authentic British voice with Google Cloud TTS</p>
        </div>
        """, unsafe_allow_html=True)
        
        # Live camera feed
        st.markdown("### üìπ Live Camera Feed")
        
        # Camera controls
        col1a, col1b, col1c = st.columns(3)
        with col1a:
            enable_camera = st.checkbox("üìπ Enable Camera", key="enable_camera")
        with col1b:
            auto_analyze = st.checkbox("üîÑ Auto-analyze (every 10s)", key="auto_analyze")
        with col1c:
            analyze_now = st.button("ÔøΩ Analyze Now", key="analyze_now")
        
        # Camera feed placeholder
        camera_placeholder = st.empty()
        commentary_placeholder = st.empty()
        
        # Initialize webcam if enabled
        if enable_camera:
            try:
                import cv2
                
                # Initialize camera
                if 'camera' not in st.session_state:
                    st.session_state.camera = cv2.VideoCapture(0)
                
                if st.session_state.camera.isOpened():
                    # Capture frame
                    ret, frame = st.session_state.camera.read()
                    if ret:
                        # Convert BGR to RGB
                        frame_rgb = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
                        
                        # Display frame
                        camera_placeholder.image(frame_rgb, caption="Live Webcam Feed", use_column_width=True)
                        
                        # Save current frame
                        os.makedirs("frames", exist_ok=True)
                        cv2.imwrite("frames/frame.jpg", frame)
                        
                        # Auto-analyze if enabled
                        if auto_analyze:
                            current_time = time.time()
                            if 'last_analysis_time' not in st.session_state:
                                st.session_state.last_analysis_time = 0
                            
                            if current_time - st.session_state.last_analysis_time > 10:  # 10 seconds
                                st.session_state.last_analysis_time = current_time
                                analyze_now = True
                        
                        # Analyze frame if requested
                        if analyze_now and NARRATOR_AVAILABLE:
                            with st.spinner("üé≠ Sir David is analyzing..."):
                                try:
                                    # Encode current frame
                                    base64_image = encode_image("frames/frame.jpg")
                                    
                                    # Load conversation history
                                    script = []
                                    if os.path.exists("david_attenborough_commentary.json"):
                                        with open("david_attenborough_commentary.json", 'r') as f:
                                            script = json.load(f)
                                    
                                    # Analyze with context
                                    analysis = analyze_image(base64_image, script)
                                    
                                    # üéôÔ∏è NARRATE the commentary (this was missing!)
                                    try:
                                        # Get voice settings from widget state
                                        voice_speed = st.session_state.get('voice_speed', 1.1)
                                        voice_pitch = st.session_state.get('voice_pitch', -1.0)
                                        play_audio(analysis, speed=voice_speed, pitch=voice_pitch)
                                    except Exception as audio_error:
                                        st.warning(f"üîá Audio playback failed: {audio_error}")
                                    
                                    # Display result
                                    commentary_placeholder.markdown(f"""
                                    <div class="status-success">
                                        <h4>üéôÔ∏è Sir David says:</h4>
                                        <p>{analysis}</p>
                                        <small><em>Analysis timestamp: {datetime.now().strftime('%H:%M:%S')}</em></small>
                                    </div>
                                    """, unsafe_allow_html=True)
                                    
                                    # Add to conversation history
                                    new_entry = {
                                        "role": "assistant",
                                        "content": analysis,
                                        "timestamp": time.time(),
                                        "frame": len(script)
                                    }
                                    
                                    script.append(new_entry)
                                    
                                    # Save updated history
                                    with open("david_attenborough_commentary.json", 'w') as f:
                                        json.dump(script, f, indent=2)
                                    
                                    # Auto-refresh for continuous analysis
                                    if auto_analyze:
                                        time.sleep(1)
                                        st.rerun()
                                    
                                except Exception as e:
                                    st.error(f"Analysis failed: {e}")
                    else:
                        camera_placeholder.error("‚ùå Could not capture frame from camera")
                else:
                    camera_placeholder.error("‚ùå Could not open camera")
                    
            except ImportError:
                camera_placeholder.error("‚ùå OpenCV not available - cannot access camera")
            except Exception as e:
                camera_placeholder.error(f"‚ùå Camera error: {e}")
        
        else:
            camera_placeholder.info("üìπ Enable camera to start live commentary")
            
            # Manual frame analysis option
            uploaded_file = st.file_uploader("üì∏ Or upload an image for analysis", type=['jpg', 'jpeg', 'png'])
            if uploaded_file is not None:
                # Display uploaded image
                image = Image.open(uploaded_file)
                st.image(image, caption="Uploaded Image", use_column_width=True)
                
                # Save for analysis
                os.makedirs("frames", exist_ok=True)
                image.save("frames/frame.jpg")
                
                if st.button("üîç Analyze Uploaded Image"):
                    if NARRATOR_AVAILABLE:
                        with st.spinner("üé≠ Sir David is analyzing your image..."):
                            try:
                                base64_image = encode_image("frames/frame.jpg")
                                
                                # Load conversation history
                                script = []
                                if os.path.exists("david_attenborough_commentary.json"):
                                    with open("david_attenborough_commentary.json", 'r') as f:
                                        script = json.load(f)
                                
                                analysis = analyze_image(base64_image, script)
                                
                                # üéôÔ∏è NARRATE the commentary (this was missing!)
                                try:
                                    # Get voice settings from widget state
                                    voice_speed = st.session_state.get('voice_speed', 1.1)
                                    voice_pitch = st.session_state.get('voice_pitch', -1.0)
                                    play_audio(analysis, speed=voice_speed, pitch=voice_pitch)
                                except Exception as audio_error:
                                    st.warning(f"üîá Audio playback failed: {audio_error}")
                                
                                commentary_placeholder.markdown(f"""
                                <div class="status-success">
                                    <h4>üéôÔ∏è Sir David says:</h4>
                                    <p>{analysis}</p>
                                </div>
                                """, unsafe_allow_html=True)
                                
                            except Exception as e:
                                st.error(f"Analysis failed: {e}")
    
    with col2:
        st.markdown("### üéôÔ∏è Sir David's Voice Settings")
        
        # Voice settings - store in session state for use during narration
        voice_speed = st.slider("Speech Rate", 0.5, 1.5, 1.1, 0.1, key='voice_speed')
        voice_pitch = st.slider("Pitch Adjustment", -5.0, 5.0, -1.0, 0.5, key='voice_pitch')
        
        # Voice preview button
        col2a, col2b = st.columns(2)
        with col2a:
            if st.button("üéôÔ∏è Test Voice Settings"):
                if NARRATOR_AVAILABLE:
                    test_text = "Hello! This is Sir David Attenborough speaking with your current voice settings. Fascinating isn't it?"
                    try:
                        play_audio(test_text, speed=voice_speed, pitch=voice_pitch)
                        st.success("üîä Voice test played!")
                    except Exception as e:
                        st.error(f"Voice test failed: {e}")
                else:
                    st.warning("Narrator not available for voice testing")
        
        with col2b:
            if st.button("‚èπÔ∏è Stop Audio"):
                if NARRATOR_AVAILABLE:
                    try:
                        stop_audio()
                        st.success("‚èπÔ∏è Audio stopped!")
                    except Exception as e:
                        st.error(f"Stop failed: {e}")
                else:
                    st.warning("No audio system available")
        
        st.markdown("### üìù Live Commentary History")
        
        # Load and display conversation history
        if os.path.exists("david_attenborough_commentary.json"):
            try:
                with open("david_attenborough_commentary.json", 'r') as f:
                    commentary_history = json.load(f)
                
                st.write(f"**{len(commentary_history)} observations saved**")
                
                if commentary_history:
                    # Show most recent entries
                    st.markdown("**Recent Live Commentary:**")
                    for i, entry in enumerate(commentary_history[-3:]):
                        timestamp = entry.get('timestamp', 0)
                        if timestamp:
                            time_str = datetime.fromtimestamp(timestamp).strftime('%H:%M:%S')
                        else:
                            time_str = "Unknown"
                        
                        with st.expander(f"üé¨ Frame {entry.get('frame', i)} at {time_str}"):
                            content = entry['content']
                            st.write(content[:300] + "..." if len(content) > 300 else content)
                
                # Clear history option
                if st.button("üóëÔ∏è Clear Commentary History"):
                    os.remove("david_attenborough_commentary.json")
                    st.success("Commentary history cleared!")
                    st.rerun()
                    
            except Exception as e:
                st.error(f"Error loading commentary history: {e}")
        else:
            st.info("No commentary history yet. Enable camera and start analyzing!")
        
        # System status
        st.markdown("### üìä System Status")
        
        # Check camera status
        camera_status = "‚è∏Ô∏è"  # Default: not initialized
        if 'camera' in st.session_state:
            if hasattr(st.session_state.camera, 'isOpened') and st.session_state.camera.isOpened():
                camera_status = "‚úÖ"
            else:
                camera_status = "‚ùå"
        
        status_items = [
            ("üé• Camera Access", camera_status),
            ("üß† Narrator AI", "‚úÖ" if NARRATOR_AVAILABLE else "‚ùå"),
            ("üìÅ Frame Directory", "‚úÖ" if os.path.exists("frames") else "‚ùå"),
            ("üíæ Auto-save", "‚úÖ" if os.path.exists("david_attenborough_commentary.json") else "‚è∏Ô∏è")
        ]
        
        for item, status in status_items:
            st.markdown(f"**{item}:** {status}")
    
    # Cleanup camera on disable
    if not enable_camera and 'camera' in st.session_state:
        if st.session_state.camera.isOpened():
            st.session_state.camera.release()
        del st.session_state.camera

def gmail_reader_tab():
    """Enhanced Celebrity Gmail Email Reader & Summarizer"""
    st.markdown("## üìß Enhanced Celebrity Gmail Reader")
    st.markdown("**üé≠ Natural celebrity voices with task-based Portia integration!**")
    
    if not GMAIL_AVAILABLE:
        st.error("‚ùå Enhanced Gmail reader not available. Please check dependencies.")
        st.markdown("""
        **To enable the enhanced Gmail reader:**
        1. Ensure `task_based_celebrity_gmail.py` exists with your enhanced implementation
        2. Install required dependencies: `pip install portia google-cloud-texttospeech`
        3. Set up Google Cloud TTS credentials if available
        """)
        return
    
    # Create columns for layout
    col1, col2 = st.columns([2, 1])
    
    with col1:
        st.markdown("### üì¨ Enhanced Gmail Analysis")
        st.markdown("*Using task-based Portia approach with natural celebrity voices*")
        
        # Gmail connection status
        gmail_status_placeholder = st.empty()
        
        # Email input settings
        st.markdown("### üéõÔ∏è Email Settings")
        
        col1a, col1b = st.columns(2)
        with col1a:
            sender_email = st.text_input(
                "üìß Sender Email (optional)", 
                placeholder="e.g., john@company.com",
                help="Leave blank to analyze all recent emails"
            )
        with col1b:
            max_emails = st.slider("Max Emails to Analyze", 5, 50, 20)
        
        # Celebrity selection with your improved lineup
        email_celebrity = st.selectbox(
            "üé≠ Choose Celebrity Email Reader:",
            ["David Attenborough", "Morgan Freeman", "Scarlett Johansson", "Peter Griffin"],
            key="email_celebrity_enhanced",
            help="Each celebrity has unique natural voice characteristics"
        )
        
        # Voice settings
        st.markdown("### üéôÔ∏è Voice Settings")
        col1a, col1b = st.columns(2)
        with col1a:
            voice_speed = st.slider("üé∂ Speaking Speed", 0.5, 2.0, 1.0, 0.1)
        with col1b:
            voice_pitch = st.slider("üéµ Voice Pitch", -5.0, 5.0, 0.0, 0.5)
        
        # Enhanced Gmail authentication and analysis
        col1a, col1b, col1c = st.columns(3)
        
        with col1a:
            if st.button("üìß Read Gmail (Enhanced)", type="primary"):
                gmail_status_placeholder.markdown("""
                <div class="status-info">
                    <h4>üîÑ Initializing Enhanced Gmail Reader...</h4>
                    <p>Using task-based Portia integration with wrapper</p>
                </div>
                """, unsafe_allow_html=True)
                
                try:
                    # Initialize enhanced Gmail reader wrapper
                    with st.spinner("üéôÔ∏è Setting up enhanced Gmail reader..."):
                        gmail_reader = GmailReader()
                    
                    # Authenticate with Portia
                    gmail_status_placeholder.markdown("""
                    <div class="status-info">
                        <h4>üîß Authenticating with Enhanced Portia...</h4>
                        <p>Task-based Gmail access setup</p>
                    </div>
                    """, unsafe_allow_html=True)
                    
                    if gmail_reader.authenticate_with_portia():
                        gmail_status_placeholder.markdown("""
                        <div class="status-success">
                            <h4>‚úÖ Enhanced Portia Gmail Connected!</h4>
                            <p>Fetching emails with task-based approach...</p>
                        </div>
                        """, unsafe_allow_html=True)
                        
                        # Fetch emails using enhanced wrapper method
                        with st.spinner(f"üîç {email_celebrity} is analyzing your emails with enhanced AI..."):
                            emails = gmail_reader.get_emails_with_portia(
                                sender_email=sender_email.strip() if sender_email.strip() else None,
                                max_results=max_emails
                            )
                            
                            if emails:
                                # Generate enhanced celebrity summary using wrapper
                                summary = gmail_reader.summarize_emails_with_celebrity(
                                    emails, email_celebrity
                                )
                                
                                # Display results
                                gmail_status_placeholder.markdown(f"""
                                <div class="status-success">
                                    <h4>üé≠ {email_celebrity}'s Enhanced Email Analysis:</h4>
                                    <p>Using natural voice characteristics and personality traits</p>
                                </div>
                                """, unsafe_allow_html=True)
                                
                                # Show enhanced script preview
                                with st.expander(f"üìú {email_celebrity}'s Enhanced Script", expanded=True):
                                    st.markdown(f"""
                                    <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                                        <p style="font-size: 1.1em; line-height: 1.6; font-style: italic;">
                                            {summary}
                                        </p>
                                    </div>
                                    """, unsafe_allow_html=True)
                                
                                # Store for voice playback
                                st.session_state['current_email_summary'] = summary
                                st.session_state['current_email_celebrity'] = email_celebrity
                                st.session_state['gmail_reader'] = gmail_reader
                                
                                # Store in history
                                if 'email_history' not in st.session_state:
                                    st.session_state.email_history = []
                                
                                st.session_state.email_history.append({
                                    'timestamp': datetime.now(),
                                    'celebrity': email_celebrity,
                                    'summary': summary[:200] + "...",
                                    'email_count': len(emails)
                                })
                                
                                st.success(f"‚úÖ Enhanced analysis complete! {len(emails)} emails processed.")
                                
                            else:
                                st.warning("üì™ No recent emails found via enhanced Portia integration.")
                                
                    else:
                        gmail_status_placeholder.markdown("""
                        <div class="status-error">
                            <h4>‚ùå Enhanced Portia Setup Failed</h4>
                            <p>Please check Portia configuration and try again</p>
                        </div>
                        """, unsafe_allow_html=True)
                        
                except Exception as e:
                    gmail_status_placeholder.markdown(f"""
                    <div class="status-error">
                        <h4>‚ùå Enhanced Gmail Reading Failed</h4>
                        <p>Error: {str(e)}</p>
                    </div>
                    """, unsafe_allow_html=True)
                    st.error(f"Detailed error: {e}")
        
        with col1b:
            # Enhanced voice playback using wrapper
            if st.button("üîä Play Enhanced Voice", type="secondary"):
                if ('current_email_summary' in st.session_state and 
                    'gmail_reader' in st.session_state):
                    
                    summary = st.session_state['current_email_summary']
                    celebrity = st.session_state['current_email_celebrity']
                    gmail_reader = st.session_state['gmail_reader']
                    
                    with st.spinner(f"üéôÔ∏è {celebrity} is speaking with enhanced natural voice..."):
                        try:
                            success = gmail_reader.speak_email_summary(summary, celebrity)
                            if success:
                                st.success(f"‚úÖ {celebrity} finished speaking with enhanced voice!")
                            else:
                                st.info(f"üìù {celebrity}'s message displayed as text (enhanced voice unavailable)")
                        except Exception as e:
                            st.error(f"Enhanced voice playback error: {e}")
                            st.markdown(f"**üó£Ô∏è {celebrity} says:**")
                            st.markdown(f"> {summary}")
                else:
                    st.warning("‚ö†Ô∏è No email analysis available. Please read Gmail first.")
        
        with col1c:
            # Stop enhanced narration using wrapper
            if st.button("‚èπÔ∏è Stop Enhanced Voice", type="secondary"):
                if 'gmail_reader' in st.session_state:
                    st.session_state['gmail_reader'].stop_narration()
                    st.info("‚èπÔ∏è Enhanced voice playback stopped")
                else:
                    st.warning("No active enhanced voice to stop")
    
    with col2:
        # Enhanced sidebar info
        st.markdown("### üé≠ Celebrity Voice Features")
        
        if email_celebrity == "David Attenborough":
            st.markdown("""
            **üá¨üáß Sir David Attenborough**
            - *Gentle, breathy British accent*
            - *Nature documentary style*  
            - *Scientific curiosity*
            - *Premium Google TTS: en-GB-Journey-D*
            """)
        elif email_celebrity == "Morgan Freeman":
            st.markdown("""
            **üé¨ Morgan Freeman**
            - *Deep, resonant narration*
            - *Dramatic pauses*
            - *Philosophical insights*
            - *Premium Google TTS: en-US-Journey-D*
            """)
        elif email_celebrity == "Scarlett Johansson":
            st.markdown("""
            **üé≠ Scarlett Johansson**
            - *Smooth, slightly husky voice*
            - *Calm confidence*
            - *Thoughtful analysis*
            - *Premium Google TTS: en-US-Journey-F*
            """)
        elif email_celebrity == "Peter Griffin":
            st.markdown("""
            **ÔøΩ Peter Griffin**
            - *High-pitched, cartoonish*
            - *Humorous commentary*
            - *Genuine moments*
            - *Premium Google TTS: en-US-Casual-K*
            """)
        
        st.markdown("---")
        st.markdown("### üöÄ Enhanced Features")
        st.markdown("""
        - **üéôÔ∏è Premium Google Cloud TTS**
        - **üîß Task-based Portia integration**
        - **üé≠ Authentic celebrity voices**
        - **üìß Natural email conversation**
        - **‚ö° Smart authentication flow**
        - **üéõÔ∏è Voice speed & pitch control**
        """)
        
        # Email history
        if 'email_history' in st.session_state and st.session_state.email_history:
            st.markdown("### üìú Recent Email Readings")
            for entry in reversed(st.session_state.email_history[-3:]):
                st.markdown(f"""
                <div style="background: rgba(255,255,255,0.05); padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0;">
                    <small><strong>{entry['celebrity']}</strong><br>
                    {entry['timestamp'].strftime('%H:%M:%S')}</small>
                </div>
                """, unsafe_allow_html=True)
        
        with col1b:
            # Narration controls
            if 'current_email_summary' in st.session_state:
                if st.button("üéôÔ∏è Start Narration", type="secondary"):
                    try:
                        gmail_reader = st.session_state.get('gmail_reader')
                        if gmail_reader:
                            voice_speed = st.session_state.get('email_voice_speed', 1.0)
                            voice_pitch = st.session_state.get('email_voice_pitch', 0.0)
                            
                            with st.spinner(f"üé¨ {st.session_state['current_email_celebrity']} is speaking..."):
                                gmail_reader.speak_email_summary(
                                    st.session_state['current_email_summary'],
                                    st.session_state['current_email_celebrity'],
                                    speed=voice_speed,
                                    pitch=voice_pitch
                                )
                            st.success("üîä Email narration completed!")
                        else:
                            st.error("Gmail reader not available for narration")
                    except Exception as e:
                        st.error(f"Narration failed: {e}")
                
                if st.button("‚èπÔ∏è Stop Narration", type="secondary"):
                    try:
                        gmail_reader = st.session_state.get('gmail_reader')
                        if gmail_reader:
                            gmail_reader.stop_narration()
                            st.success("‚èπÔ∏è Narration stopped!")
                        else:
                            st.warning("No active narration to stop")
                    except Exception as e:
                        st.error(f"Stop failed: {e}")
        
        # Quick email actions
        st.markdown("### ‚ö° Quick Actions")
        
        if st.button("üîÑ Refresh Email Analysis"):
            st.rerun()
        
        # Gmail setup instructions
        with st.expander("üìù Gmail Setup Instructions"):
            st.markdown("""
            **To enable Gmail reading with Portia:**
            
            1. **Portia Setup:**
               - Ensure Portia SDK is installed: `pip install portia`
               - Portia will handle Gmail authentication automatically
               - No additional Google Cloud Console setup needed
               
            2. **Authentication Flow:**
               - Click "Read My Gmail" button
               - Portia will guide you through OAuth authentication
               - Complete the authentication in your browser
               - Gmail access will be handled via Portia tools
               
            3. **Supported Features:**
               - Recent email analysis with celebrity voices
               - Natural voice narration with start/stop controls
               - Email summaries with personality-based insights
               
            4. **Celebrities Available:**
               - **David Attenborough**: Nature documentary style
               - **Morgan Freeman**: Deep, philosophical narration  
               - **Scarlett Johansson**: Modern, sophisticated voice
               - **Peter Griffin**: Humorous Family Guy style
               
            5. **Voice Controls:**
               - Start/Stop narration buttons
               - Voice speed and pitch adjustments
               - Natural Google Cloud TTS voices
            """)
    
    with col2:
        st.markdown("### üéôÔ∏è Email Voice Settings")
        
        # Voice settings (reuse from narrator)
        voice_speed = st.slider("Email Speech Rate", 0.5, 1.5, 1.0, 0.1, key='email_voice_speed')
        voice_pitch = st.slider("Email Pitch", -5.0, 5.0, -1.0, 0.5, key='email_voice_pitch')
        
        # Voice preview for emails
        if st.button("üéôÔ∏è Test Email Voice"):
            test_text = f"Hello! This is {st.session_state.get('email_celebrity', 'David Attenborough')} reading your email summary with these voice settings."
            try:
                play_audio(test_text, speed=voice_speed, pitch=voice_pitch)
                st.success("üîä Voice test played!")
            except Exception as e:
                st.error(f"Voice test failed: {e}")
        
        st.markdown("### üìä Email Analysis History")
        
        # Display email analysis history
        if 'email_history' in st.session_state and st.session_state.email_history:
            st.write(f"**{len(st.session_state.email_history)} analyses completed**")
            
            # Show recent analyses
            for i, analysis in enumerate(st.session_state.email_history[-3:]):
                timestamp = analysis['timestamp'].strftime('%H:%M:%S')
                with st.expander(f"üìß {analysis['celebrity']} at {timestamp}"):
                    st.write(f"**Emails analyzed:** {analysis['email_count']}")
                    summary_preview = analysis['summary'][:200] + "..." if len(analysis['summary']) > 200 else analysis['summary']
                    st.write(summary_preview)
                    
                    # Replay audio button
                    if st.button(f"üîä Replay Analysis {i+1}", key=f"replay_{i}"):
                        try:
                            play_audio(analysis['summary'], speed=voice_speed, pitch=voice_pitch)
                            st.success("üîä Email analysis replayed!")
                        except Exception as e:
                            st.error(f"Replay failed: {e}")
            
            # Clear history button
            if st.button("üóëÔ∏è Clear Email History"):
                st.session_state.email_history = []
                st.success("Email history cleared!")
                st.rerun()
        else:
            st.info("No email analyses yet. Click 'Read My Gmail' to start!")
        
        # System status
        st.markdown("### üìä Gmail System Status")
        
        gmail_status_items = [
            ("üìß Gmail Reader", "‚úÖ" if GMAIL_AVAILABLE else "‚ùå"),
            ("ü§ñ Portia Tools", "‚úÖ" if 'portia' in sys.modules else "‚ùå"),
            ("üéôÔ∏è Voice Synthesis", "‚úÖ" if NARRATOR_AVAILABLE else "‚ùå"),
            ("ÔøΩ Natural Voices", "‚úÖ" if os.getenv('GOOGLE_APPLICATION_CREDENTIALS') else "‚è∏Ô∏è")
        ]
        
        for item, status in gmail_status_items:
            st.markdown(f"**{item}:** {status}")

def calendar_assistant_tab():
    """Celebrity Calendar Assistant"""
    st.markdown("## üìÖ Celebrity Calendar Assistant")
    st.markdown("**Manage your Google Calendar with celebrity voices reading your REAL events!**")
    
    # Initialize calendar system
    if not init_calendar_system():
        st.error("‚ùå Calendar system not available")
        return
    
    col1, col2 = st.columns([2, 1])
    
    with col1:
        st.markdown("### üìã Calendar Operations")
        
        # Calendar action selection
        action = st.selectbox(
            "Choose calendar action:",
            [
                "get events",
                "today events", 
                "tomorrow events",
                "check availability",
                "create event",
                "delete event"
            ],
            format_func=lambda x: {
                "get events": "üìÖ View upcoming events",
                "today events": "üìÜ Today's schedule",
                "tomorrow events": "üìÖ Tomorrow's events", 
                "check availability": "üïê Check availability",
                "create event": "‚ûï Create new event",
                "delete event": "üóëÔ∏è Delete event"
            }.get(x, x)
        )
        
        # Additional details for create/delete
        details = ""
        if action in ["create event", "delete event"]:
            details = st.text_input(
                f"Event details for {action}:",
                placeholder="Enter event name/description"
            )
        
        # Celebrity voice selection for calendar
        calendar_celebrity = st.selectbox(
            "Choose celebrity voice:",
            ["David Attenborough", "Morgan Freeman", "Scarlett Johansson", "Peter Griffin"]
        )
        
        # Execute calendar action
        if st.button("üé≠ Execute with Celebrity Voice", key="calendar_execute"):
            if st.session_state.portia_calendar is None:
                st.warning("‚ùå Real calendar access unavailable (Portia timeout)")
                st.info("üé≠ Demonstrating celebrity voice with sample calendar data")
                
                # Demo calendar data
                demo_calendar_data = {
                    "get events": "You have 3 upcoming events: 1) Team standup meeting at 9:00 AM tomorrow, 2) Project review at 2:00 PM on Wednesday, 3) Client presentation on Friday at 10:00 AM.",
                    "today events": f"Today is {datetime.now().strftime('%B %d, %Y')}. You have a team meeting at 10:00 AM and lunch with Sarah at 12:30 PM.",
                    "tomorrow events": f"Tomorrow you have: Morning standup at 9:00 AM, Design review at 2:00 PM, and Gym session at 6:00 PM.",
                    "check availability": "You are free from 10:00 AM to 12:00 PM today, and from 3:00 PM to 5:00 PM tomorrow.",
                    "create event": f"I've created a sample event: '{details}' scheduled for tomorrow at 2:00 PM." if details else "I've created a sample meeting for tomorrow at 2:00 PM.",
                    "delete event": f"I've deleted the event: '{details}' from your calendar." if details else "I've deleted the selected event from your calendar."
                }
                
                result = demo_calendar_data.get(action, "Sample calendar operation completed.")
                
                with st.spinner(f"üé≠ {calendar_celebrity} is preparing your response..."):
                    # Generate celebrity response
                    content_model = setup_content_generator()
                    if content_model:
                        script = generate_calendar_script(
                            content_model,
                            calendar_celebrity,
                            action,
                            result,
                            st.session_state.calendar_voice
                        )
                    else:
                        script = f"Hello! This is {calendar_celebrity}. {result}"
                    
                    # Display celebrity response
                    st.markdown(f"""
                    <div class="celebrity-card">
                        <h4>üé≠ {calendar_celebrity} says:</h4>
                        <p>{script}</p>
                        <small><em>Demo mode - not connected to real calendar</em></small>
                    </div>
                    """, unsafe_allow_html=True)
                    
                    # Play voice if available
                    if st.session_state.calendar_voice:
                        try:
                            st.session_state.calendar_voice.speak_calendar_event(script, calendar_celebrity)
                            st.info("üîä Audio played through system speakers")
                        except Exception as e:
                            st.warning(f"Voice playback failed: {e}")
                
                return
                
            with st.spinner(f"üìÖ {calendar_celebrity} is accessing your calendar..."):
                try:
                    # Execute calendar action
                    result = execute_calendar_action_with_portia(
                        st.session_state.portia_calendar,
                        action,
                        details
                    )
                    
                    if result:
                        st.success("‚úÖ Calendar action completed!")
                        
                        # Generate celebrity response
                        content_model = setup_content_generator()
                        script = generate_calendar_script(
                            content_model,
                            calendar_celebrity,
                            action,
                            result,
                            st.session_state.calendar_voice
                        )
                        
                        # Display celebrity response
                        st.markdown(f"""
                        <div class="celebrity-card">
                            <h4>üé≠ {calendar_celebrity} says:</h4>
                            <p>{script}</p>
                        </div>
                        """, unsafe_allow_html=True)
                        
                        # Play voice if available
                        if st.session_state.calendar_voice:
                            try:
                                st.session_state.calendar_voice.speak_calendar_event(script, calendar_celebrity)
                                st.info("üîä Audio played through system speakers")
                            except Exception as e:
                                st.warning(f"Voice playback failed: {e}")
                        
                        # Show raw calendar data
                        with st.expander("üìä Raw Calendar Data"):
                            st.text(result)
                    else:
                        st.error("‚ùå No calendar data received")
                        
                except Exception as e:
                    st.error(f"Calendar action failed: {e}")
    
    with col2:
        st.markdown("### üîä Voice Settings")
        
        # Voice configuration
        st.markdown("**Celebrity Voice Characteristics:**")
        if calendar_celebrity == "David Attenborough":
            st.markdown("üåø **Nature documentarian** - Gentle, awe-inspired British tone")
        elif calendar_celebrity == "Morgan Freeman":
            st.markdown("üé¨ **Wise narrator** - Deep, resonant with dramatic pauses")
        elif calendar_celebrity == "Scarlett Johansson":
            st.markdown("üî• **Modern sophistication** - Smooth, slightly husky warmth")
        elif calendar_celebrity == "Peter Griffin":
            st.markdown("üòÇ **Comedy relief** - Playful, exaggerated with laughter")
        
        st.markdown("### üìà System Status")
        
        # System status
        status_items = [
            ("Google Cloud TTS", "‚úÖ" if st.session_state.calendar_voice else "‚ùå"),
            ("Portia SDK", "‚úÖ" if st.session_state.portia_calendar else "‚ùå"), 
            ("Calendar Access", "‚úÖ" if st.session_state.portia_calendar else "‚ùå"),
            ("Audio System", "‚úÖ" if st.session_state.calendar_voice and st.session_state.calendar_voice else "‚ùå")
        ]
        
        for item, status in status_items:
            st.markdown(f"**{item}:** {status}")
        
        st.markdown("### üìö Quick Actions")
        
        quick_actions = [
            ("üìÖ Today's Events", "today events", ""),
            ("üìÜ Tomorrow's Events", "tomorrow events", ""),
            ("üïê Check Free Time", "check availability", ""),
            ("üìã All Upcoming", "get events", "")
        ]
        
        for label, action_type, detail in quick_actions:
            if st.button(label, key=f"quick_{action_type}"):
                # Quick execute
                with st.spinner(f"{calendar_celebrity} checking calendar..."):
                    try:
                        result = execute_calendar_action_with_portia(
                            st.session_state.portia_calendar,
                            action_type,
                            detail
                        )
                        
                        if result:
                            st.success(f"‚úÖ {label} completed")
                            with st.expander("Results"):
                                st.text(result[:500] + "..." if len(result) > 500 else result)
                    except Exception as e:
                        st.error(f"Quick action failed: {e}")

def celebrity_chat_tab():
    """Celebrity Companion Chat"""
    st.markdown("## üí¨ Celebrity Companion Chat")
    st.markdown("**Have natural conversations with AI celebrities for emotional support and entertainment!**")
    
    # Initialize companion AI
    if not init_companion_ai():
        st.error("‚ùå Celebrity Companion AI not available")
        return
    
    col1, col2 = st.columns([2, 1])
    
    with col1:
        st.markdown("### üí≠ Chat Interface")
        
        # Chat history display
        chat_container = st.container()
        
        with chat_container:
            for message in st.session_state.chat_history[-10:]:  # Show last 10 messages
                if message.startswith("User:"):
                    st.markdown(f"""
                    <div class="chat-message chat-user">
                        <strong>You:</strong> {message[5:].strip()}
                    </div>
                    """, unsafe_allow_html=True)
                else:
                    # Extract celebrity name and message
                    if ":" in message:
                        celebrity_name, msg = message.split(":", 1)
                        st.markdown(f"""
                        <div class="chat-message chat-celebrity">
                            <strong>üé≠ {celebrity_name.strip()}:</strong> {msg.strip()}
                        </div>
                        """, unsafe_allow_html=True)
        
        # Chat input
        st.markdown("---")
        user_input = st.text_area(
            "üí¨ Your message:",
            height=100,
            placeholder="Type your message here... I'll automatically select the best celebrity for you!"
        )
        
        col1a, col1b, col1c = st.columns([2, 1, 1])
        with col1a:
            send_message = st.button("üöÄ Send Message", key="send_chat")
        with col1b:
            clear_history = st.button("üóëÔ∏è Clear History", key="clear_chat")
        with col1c:
            voice_enabled = st.checkbox("üîä Enable Voice", value=True)
        
        # Handle message sending
        if send_message and user_input.strip():
            with st.spinner("üé≠ Celebrity is thinking..."):
                try:
                    # Get celebrity response
                    response = st.session_state.companion_ai.chat(user_input.strip())
                    
                    # Add to session state
                    st.session_state.chat_history.append(f"User: {user_input.strip()}")
                    st.session_state.chat_history.append(response)
                    
                    # Save to file
                    save_chat_history()
                    
                    # Play voice if enabled
                    if voice_enabled and hasattr(st.session_state.companion_ai, 'speak_text'):
                        try:
                            st.session_state.companion_ai.speak_text(response.split(":", 1)[1] if ":" in response else response)
                        except Exception as e:
                            st.warning(f"Voice playback failed: {e}")
                    
                    st.rerun()
                    
                except Exception as e:
                    st.error(f"Chat failed: {e}")
        
        # Clear history
        if clear_history:
            st.session_state.chat_history = []
            save_chat_history()
            st.success("Chat history cleared!")
            st.rerun()
    
    with col2:
        st.markdown("### üé≠ Celebrity Info")
        
        # Current celebrity info
        if st.session_state.companion_ai and st.session_state.companion_ai.current_celebrity:
            current_celeb = st.session_state.companion_ai.current_celebrity
            celeb_info = st.session_state.companion_ai.celebrities[current_celeb]
            
            st.markdown(f"""
            <div class="celebrity-card">
                <h4>Currently Active: {celeb_info['name']}</h4>
                <p><strong>Personality:</strong> {celeb_info['personality']}</p>
                <p><strong>Style:</strong> {celeb_info['style']}</p>
                <p><strong>Specialties:</strong> {', '.join(celeb_info['specialties'])}</p>
            </div>
            """, unsafe_allow_html=True)
        
        st.markdown("### üß† AI Selection Logic")
        st.markdown("""
        **The AI automatically selects celebrities based on:**
        - **Anxiety/Stress** ‚Üí David Attenborough (calming nature)
        - **Sadness/Grief** ‚Üí Morgan Freeman (deep comfort) 
        - **Anger/Frustration** ‚Üí Scarlett Johansson (emotional intelligence)
        - **General/Humor** ‚Üí Peter Griffin (relatable fun)
        """)
        
        st.markdown("### üîß Manual Override")
        
        # Manual celebrity switching
        celebrity_override = st.selectbox(
            "Force switch to:",
            ["Auto-Select"] + list(st.session_state.companion_ai.celebrities.keys()) if st.session_state.companion_ai else ["Auto-Select"],
            format_func=lambda x: {
                "Auto-Select": "ü§ñ Smart Selection",
                "david": "üåø David Attenborough",
                "morgan": "üé¨ Morgan Freeman", 
                "scarlett": "üî• Scarlett Johansson",
                "peter": "üòÇ Peter Griffin"
            }.get(x, x)
        )
        
        if celebrity_override != "Auto-Select":
            if st.button("üîÑ Switch Celebrity"):
                if st.session_state.companion_ai:
                    st.session_state.companion_ai.current_celebrity = celebrity_override
                    st.success(f"Switched to {st.session_state.companion_ai.celebrities[celebrity_override]['name']}")
                    st.rerun()
        
        st.markdown("### üìä Chat Statistics")
        
        if st.session_state.chat_history:
            total_messages = len(st.session_state.chat_history)
            user_messages = len([msg for msg in st.session_state.chat_history if msg.startswith("User:")])
            celebrity_messages = total_messages - user_messages
            
            st.markdown(f"""
            - **Total Messages:** {total_messages}
            - **Your Messages:** {user_messages}
            - **Celebrity Responses:** {celebrity_messages}
            """)

def settings_tab():
    """Settings and Configuration"""
    st.markdown("## ‚öôÔ∏è Settings & Configuration")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("### üîë API Configuration")
        
        # API Keys (masked for security)
        google_api = os.getenv('GOOGLE_API_KEY', '')
        google_creds = os.getenv('GOOGLE_APPLICATION_CREDENTIALS', '')
        portia_api = os.getenv('PORTIA_API_KEY', '')
        
        st.markdown(f"""
        **Google API Key:** {'‚úÖ Configured' if google_api and google_api != 'dummy_key_for_testing' else '‚ùå Not configured'}
        
        **Google Cloud Credentials:** {'‚úÖ Configured' if google_creds else '‚ùå Not configured'}
        
        **Portia API Key:** {'‚úÖ Configured' if portia_api else '‚ùå Not configured'}
        """)
        
        if st.button("üîÑ Reload Environment"):
            from dotenv import load_dotenv
            load_dotenv(override=True)
            st.success("Environment variables reloaded!")
        
        st.markdown("### üéµ Audio Settings")
        
        # Audio system checks
        audio_systems = []
        try:
            result = subprocess.run(['which', 'paplay'], capture_output=True, text=True)
            if result.returncode == 0:
                audio_systems.append("PulseAudio (paplay)")
        except:
            pass
        
        try:
            result = subprocess.run(['which', 'aplay'], capture_output=True, text=True)
            if result.returncode == 0:
                audio_systems.append("ALSA (aplay)")
        except:
            pass
        
        try:
            import pygame
            audio_systems.append("Pygame")
        except:
            pass
        
        st.markdown("**Available Audio Systems:**")
        for system in audio_systems:
            st.markdown(f"‚úÖ {system}")
        
        if not audio_systems:
            st.markdown("‚ùå No audio systems detected")
    
    with col2:
        st.markdown("### üìä System Status")
        
        # Module availability
        modules = [
            ("Narrator Module", NARRATOR_AVAILABLE),
            ("Celebrity Companion", COMPANION_AVAILABLE),
            ("Calendar Assistant", CALENDAR_AVAILABLE),
            ("Google Cloud TTS", 'google.cloud.texttospeech' in sys.modules),
            ("Streamlit", True),
            ("OpenCV", 'cv2' in sys.modules),
            ("Pygame", 'pygame' in sys.modules)
        ]
        
        for module, available in modules:
            status = "‚úÖ" if available else "‚ùå"
            st.markdown(f"**{module}:** {status}")
        
        st.markdown("### üóÇÔ∏è File Management")
        
        # File operations
        files_to_check = [
            ("narrator.py", "Webcam Narrator"),
            ("celebrity_companion_ai_clean.py", "Celebrity Companion"),
            ("celebrity_calendar_assistant.py", "Calendar Assistant"),
            ("david_attenborough_commentary.json", "Commentary History"),
            ("streamlit_chat_history.json", "Chat History"),
            (".env", "Environment Config")
        ]
        
        st.markdown("**Project Files:**")
        for filename, description in files_to_check:
            exists = os.path.exists(filename)
            status = "‚úÖ" if exists else "‚ùå"
            st.markdown(f"**{description}:** {status}")
        
        # Clear data options
        st.markdown("### üßπ Data Management")
        
        if st.button("üóëÔ∏è Clear Commentary History"):
            if os.path.exists("david_attenborough_commentary.json"):
                os.remove("david_attenborough_commentary.json")
                st.success("Commentary history cleared!")
            else:
                st.info("No commentary history to clear")
        
        if st.button("üóëÔ∏è Clear Chat History"):
            st.session_state.chat_history = []
            if os.path.exists(st.session_state.conversation_file):
                os.remove(st.session_state.conversation_file)
            st.success("Chat history cleared!")
        
        st.markdown("### üöÄ Quick Actions")
        
        if st.button("üîß Test All Systems"):
            with st.spinner("Testing all systems..."):
                results = []
                
                # Test companion AI
                if init_companion_ai():
                    results.append("‚úÖ Celebrity Companion AI: Working")
                else:
                    results.append("‚ùå Celebrity Companion AI: Failed")
                
                # Test calendar
                if init_calendar_system():
                    results.append("‚úÖ Calendar System: Working") 
                else:
                    results.append("‚ùå Calendar System: Failed")
                
                # Test narrator
                if NARRATOR_AVAILABLE:
                    results.append("‚úÖ Webcam Narrator: Available")
                else:
                    results.append("‚ùå Webcam Narrator: Not Available")
                
                for result in results:
                    if "‚úÖ" in result:
                        st.success(result)
                    else:
                        st.error(result)

def main():
    """Main Streamlit App"""
    
    # Main header
    main_header()
    
    # Sidebar
    with st.sidebar:
        st.markdown("## üéõÔ∏è Control Panel")
        
        # App selection
        app_mode = st.selectbox(
            "üé¨ Choose Celebrity AI Feature:",
            [
                "üé• Webcam Narrator", 
                "ÔøΩ Gmail Reader",
                "ÔøΩüìÖ Calendar Assistant",
                "üí¨ Celebrity Chat", 
                "‚öôÔ∏è Settings"
            ]
        )
        
        # Celebrity selection for relevant modes
        if app_mode in ["üí¨ Celebrity Chat", "üìÖ Calendar Assistant"]:
            celebrity_selection_sidebar()
        
        st.markdown("---")
        
        # Quick status
        st.markdown("### üìä Quick Status")
        st.markdown(f"**Narrator:** {'üü¢ Available' if NARRATOR_AVAILABLE else 'üî¥ Unavailable'}")
        st.markdown(f"**Gmail Reader:** {'üü¢ Available' if GMAIL_AVAILABLE else 'üî¥ Unavailable'}")
        st.markdown(f"**Companion:** {'üü¢ Ready' if COMPANION_AVAILABLE else 'üî¥ Unavailable'}")
        st.markdown(f"**Calendar:** {'üü¢ Ready' if CALENDAR_AVAILABLE else 'üî¥ Unavailable'}")
        
        st.markdown("---")
        
        # Links and info
        st.markdown("### üîó Quick Links")
        st.markdown("[üìö Project README](./README.md)")
        st.markdown("[üêô GitHub Repository](https://github.com/yashpal2104/agent-hacks-serverless-ai-agent)")
        
        st.markdown("### üí° Tips")
        st.markdown("""
        - **First time?** Check Settings tab for configuration
        - **No audio?** Check your system speakers
        - **Gmail setup?** Download credentials.json from Google Cloud Console
        - **Calendar issues?** Verify Google API credentials
        - **Chat not working?** Ensure Google API key is set
        """)
    
    # Main content area based on selected mode
    if app_mode == "üé• Webcam Narrator":
        webcam_narrator_tab()
    elif app_mode == "ÔøΩ Gmail Reader":
        gmail_reader_tab()
    elif app_mode == "ÔøΩüìÖ Calendar Assistant":
        calendar_assistant_tab()
    elif app_mode == "üí¨ Celebrity Chat":
        celebrity_chat_tab()
    elif app_mode == "‚öôÔ∏è Settings":
        settings_tab()
    
    # Footer
    st.markdown("---")
    st.markdown("""
    <div style="text-align: center; color: #666; padding: 2rem;">
        <p>üé≠ <strong>Celebrity AI Assistant Suite</strong> - Bringing AI personalities to life!</p>
        <p>Made with ‚ù§Ô∏è using Streamlit, Google AI, and Portia SDK</p>
    </div>
    """, unsafe_allow_html=True)

if __name__ == "__main__":
    main()
